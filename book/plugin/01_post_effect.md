# ãƒã‚¹ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
**ãƒã‚¹ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯alpha.4ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ãªã‚‹äºˆå®šã§ã™ã€‚**
**ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯alpha.2ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä»•æ§˜ã«åŸºã¥ã„ã¦æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€alpha.4ã§ã¯ä»•æ§˜ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒå¤§ã„ã«ã‚ã‚Šã¾ã™ğŸ™‡**

----

ãƒã‚¹ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã¯ã€ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã«ã‚ˆã£ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸç”»ç´ æƒ…å ±ã‚’åŠ å·¥ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

[ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(GitHub)](https://github.com/Ragg-/Delir/tree/master/src/delir-core/plugin-example)
[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/Ragg-/Delir/files/906748/plugin-example-88bd02b.zip)

## é–‹ç™ºã®ã¯ã˜ã‚æ–¹
- **äº‹å‰ã«`Node.js`ã¨`yarn`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚**
- é–‹ç™ºã«ã¯VisualStudio Codeã®ä½¿ç”¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ä»¥ä¸‹ã®å ´æ‰€ã«ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨å±•é–‹ã—ã¾ã—ã‚‡ã†ã€‚
ï¼ˆdelir/plugins/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å/package.json ãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼‰

Windows: `%AppData%\delir\plugins`
macOS: `$HOME/Library/Application\ Support/delir/plugins/`

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å±•é–‹ã—ãŸã‚‰ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰å±•é–‹ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã¸ç§»å‹•(cd)ã—ã¦
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„

```shell
# Put below commands into shell
yarn install # ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
yarn dev # æ›´æ–°ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§é–‹ç™ºã‚’å§‹ã‚ã‚‹ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã‚‹ã¨è‡ªå‹•çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒè¡Œã‚ã‚Œã‚‹ï¼‰
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
- package.json - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜è¿°
- src - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
    - index.ts - ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã«ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
- dist - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œã‚³ãƒ¼ãƒ‰ã®å‡ºåŠ›å…ˆ

## package.json ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¤ã„ã¦
### `engines.delir`
å‹•ä½œå¯¾è±¡ã¨ãªã‚‹Delirã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```json5
{
    "engines": {
        "delir": "0.0.x" // => Support delir v0.0.*
    }
}
```

### delir
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¤ã„ã¦ã®è©³ç´°æƒ…å ±ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```json5
{
  "delir": {
    "feature": "CustomLayer",
    "targetApi": {
        "renderer": "0.0.x"
    },
    // AssetãŒã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã¨ãã«
    // ãã®AssetãŒå·¦å´ã«æŒ‡å®šã•ã‚ŒãŸMimeTypeã¨ãƒãƒƒãƒã™ã‚‹ã¨ã€
    // å³å´ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸Assetã‚’è¨­å®šã—ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
    "acceptFileTypes": {
        // "mimetype": "default assign property name"
        "video/mp4": "source"
    }
  }
}
```

## ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### `static provideParameters()`
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§åˆ©ç”¨å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
`delir-core`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æä¾›ã•ã‚Œã‚‹Typeã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ã¾ã™ã€‚
ç¾åœ¨ã¯ä»¥ä¸‹ã®å‹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

- number - æ•´æ•°å‹
- float - å°æ•°å‹
- bool - çœŸå½å‹
- colorRgb - é€æ˜åº¦ãªã—Colorå‹
- colorRgba - é€æ˜åº¦ã¤ãColorå‹
- asset - Assetå‹ï¼ˆAssetã«è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã«åˆ©ç”¨ã—ã¾ã™ï¼‰

provideParametersãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ã¾ã™ã€‚

```javascript
return Type
    // .<å‹å>('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å', {ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³})
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ label - ãƒ¦ãƒ¼ã‚¶ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’æŒ‡å®šã—ã¾ã™ã€‚
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ defaultValue - åˆæœŸå€¤ã‚’æŒ‡å®šã—ã¾ã™
    .number('x', {label: 'PositionX', defaultValue: 0})
    .number('y', {label: 'PositionY', defaultValue: 0})
    .bool('visibility', {label: 'Visible', defaultValue: true})
    .asset('image', {label: 'Image', extensions: ['jpg', 'jpeg', 'png', 'gif']})
```

### `async beforeRender(preRenderReq: PluginPreRenderRequest)`
ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹å‰ã®åˆæœŸåŒ–å‡¦ç†ã§å‘¼ã°ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ç”»åƒãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¯ã“ã“ã§è¡Œã„ã¾ã™ã€‚

`preRenderReq`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€Assetãªã©ã®åˆæœŸå€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

```javascript
async beforeRender(preRenderReq: PluginPreRenderRequest) {
    // preRenderReq.parametersã«provideParametersãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã§åˆæœŸå€¤ãŒæ¸¡ã•ã‚Œã¾ã™
    const parameters = preRenderReq.parameters;
    const imageAsset = parameters.image;

    if (! imageAsset == null) return;

    this.image = new Image();
    this.image.src = imageAsset.path;

    // ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
    await new Promise(resolve => this.image.onload = resolve)
}
```

### `async render(req: RenderRequest)`
ï¼‘ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚
`req`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯`å‡ºåŠ›å…ˆã®canvas`ã€ `ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ`ã€`ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã®ã‚µã‚¤ã‚º`ã€`ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ä¸Šã®ç¾åœ¨æ™‚é–“ï¼ˆãŠã‚ˆã³ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ï¼‰`ã€`ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`ãªã©ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

```javascript
async render(req: RenderRequest)
{
    if (this.image == null) return;

    const dest = req.destCanvas;
    const context = dest.getContext('2d');

    // req.parametersã«provideParametersãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã§ã€ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã®å€¤ãŒæ¸¡ã•ã‚Œã¾ã™
    const params = req.parameters;

    if (params.visibility !== false) {
        context.drawImage(this.image, params.x, params.y)
    }
}
```
